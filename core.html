<!DOCTYPE html>
<html lang="zh_cn">
	<head>
		<link rel="icon" type="image/bmp" href="favicon.bmp" />
		<link rel="stylesheet" href="css/all.css" />
		<meta charset="utf-8" />
		<meta http-equiv="X-UA-Compatible" content="IE=edge" />
		<meta name="HandheldFriendly" content="True" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="stylesheet" href="css/chat.css" />
		<meta name="author" content="zyc2024" />
		<link rel="stylesheet" href="katex/katex.min.css" />
		<meta name="description" content="chatting website by zyc2024" />
		<script src="js/api.js"></script>
		<title>zyc2024的聊天网页</title>
	</head>
	<body>
		<h1 id="titlee">Loading...</h1>
		<div>
			<div class="chat">
				<article>
					<div>
						<!-- 资源加载进度条 -->
						<div
							id="progress-container"
							style="
								width: 100%;
								background: #eee;
								height: 8px;
								margin-bottom: 10px;
							">
							<div
								id="progress-bar"
								style="
									width: 0%;
									height: 100%;
									background: #4caf50;
									transition: width 0.3s;
								"></div>
						</div>
						<script>
							// 需要加载的脚本资源
							let typee = getarg().type;
							let scripts = [
								"https://code.jquery.com/jquery-3.6.0.min.js",
								"js/base64.min.js",
								"js/spark-md5.min.js",
								"js/api.js",
								// "js/md.js",
								"npmjs/markdown-it.min.js",
								"npmjs/markdown-it-task-lists.min.js",
								"npmjs/markdown-it-multimd-table.min.js",
								"npmjs/katex.min.js",
								"npmjs/purify.min.js",
							];
							if (typee == "u") {
								scripts.push("js/f.js");
							} else {
								scripts.push("js/pf.js");
							}
							let loaded = 0;
							const progressBar =
								document.getElementById("progress-bar");
							function updateProgress() {
								const percent = Math.round(
									(loaded / scripts.length) * 100
								);
								progressBar.style.width = percent + "%";
								if (loaded === scripts.length) {
									setTimeout(() => {
										document.getElementById(
											"progress-container"
										).style.display = "none";
										document.getElementById(
											"progress-info"
										).style.display = "none";
									}, 300);
								}
							}
							function loadScript(src) {
								return new Promise((resolve, reject) => {
									const s = document.createElement("script");
									s.src = src;
									s.onload = () => {
										loaded++;
										updateProgress();
										resolve();
									};
									s.onerror = reject;
									document.body.appendChild(s);
								});
							}
							(async () => {
								for (const src of scripts) {
									await loadScript(src);
								}
							})();
						</script>
					</div>
					<div id="chat"></div>
					<br />
					<div style="display: flex; height: 200px">
						<textarea
							id="editor"
							placeholder="输入消息，右边是Markdown的预览"></textarea>

						<div id="preview"></div>
						<script src="npmjs/markdown-it.min.js"></script>
						<!-- <script src="https://cdn.jsdelivr.net/npm/markdown-it-emoji/dist/markdown-it-emoji.min.js"></script> -->
						<script src="npmjs/markdown-it-task-lists.min.js"></script>
						<script src="npmjs/markdown-it-multimd-table.min.js"></script>
						<script src="npmjs/katex.min.js"></script>
						<script src="npmjs/purify.min.js"></script>
						<script>
							// 初始化 markdown-it
							const md = window
								.markdownit({ html: true })
								// .use(window.markdownitEmoji)
								.use(window.markdownitTaskLists)
								.use(window.markdownitMultimdTable);

							// KaTeX 预处理
							function preRenderTex(source) {
								// 块级公式
								source = source.replace(
									/\$\$([\s\S]+?)\$\$/g,
									(m, tex) =>
										katex.renderToString(tex, {
											displayMode: true,
											throwOnError: false,
											output: "html",
										})
								);
								// 行内公式
								source = source.replace(
									/(^|[^$])\$([^\n$][^$]*?)\$([^$]|$)/g,
									(m, p1, tex, p3) =>
										p1 +
										katex.renderToString(tex, {
											displayMode: false,
											throwOnError: false,
											output: "html",
										}) +
										p3
								);
								return source;
							}

							function render() {
								const src =
									document.getElementById("editor").value;
								const preProcessed = preRenderTex(src);
								const dirty = md.render(preProcessed);

								// 清理 XSS，同时保留 KaTeX 生成的 span/class
								const clean = DOMPurify.sanitize(dirty, {
									ADD_TAGS: ["span"],
									ADD_ATTR: ["class", "style"],
								});

								document.getElementById("preview").innerHTML =
									clean;
							}

							document
								.getElementById("editor")
								.addEventListener("input", render);
							render();
						</script>
					</div>
					<br />
					<button id="button" onclick="javascript:upload()">
						发送
					</button>
					<button onclick="javascript:reload()">刷新</button>
					<button onclick="javascript:cname()">改名</button>
					<button onclick="javascript:window.location.href='/chat/'">
						回到主页</button
					><button
						onclick="javascript:window.location.href='/chat/mdtest.html'">
						全屏预览Markdown
					</button>
					<button
						onclick="javascript:document.location.href='uf.html'">
						上传文件界面
					</button>
					<button onclick="javascript:crt()">修改刷新时间</button>
					<br /><br />
					<script>
						if (getarg().type == "u") {
							document.getElementsByTagName(
								"article"
							)[0].innerHTML +=
								'<form onsubmit="event.preventDefault();window.location.href=window.location.href.split(\'?\')[0]+\'?type=u&ch=\'+document.getElementById(\'ch\').value;return false;"><input id="ch" placeholder="输入你想去的频道"><button type="submit">go!</button></form>';
						}
					</script>
					现在刷新时间：<span id="refreshtime">5</span>秒
					<div id="nname"></div>
					<script>
						function showname() {
							document.getElementById("nname").innerText =
								"现在的用户名：" + getname();
						}
						// showname();
					</script>
				</article>
			</div>
		</div>
	</body>
</html>
