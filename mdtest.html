<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Markdown + KaTeX Demo</title>
		<link
			rel="stylesheet"
			href="lib/katex.min.js" />

		<style>
			body {
				font-family: sans-serif;
				display: flex;
				gap: 1rem;
				padding: 1rem;
			}
			textarea {
				width: 40%;
				height: 90vh;
			}
			#preview {
				width: 55%;
				padding: 1rem;
				border: 1px solid #ccc;
				height: 90vh;
				overflow: auto;
			}
			#preview table,
			th,
			td {
				border: 1px solid #000;
				border-collapse: collapse;
				padding: 5px;
			}
		</style>
	</head>
	<body>
		<textarea id="editor">
# 测试 Markdown + KaTeX

- [x] 已完成
- [ ] 待完成

行内公式：$E = mc^2$

块级公式：
$$
\int_0^1 x^2 dx = \frac{1}{3}
$$

| 姓名 | 分数 |
| ---- | ---- |
| 小明 | 95 |
| 小红 | 88 |
</textarea
		>

		<div id="preview"></div>

		<!-- 引入依赖（CDN） -->
		<script src="lib/markdown-it.min.js"></script>
		<script src="lib/markdown-it-task-lists.min.js"></script>
		<script src="lib/markdown-it-multimd-table.min.js"></script>
		<script src="lib/katex.min.js"></script>
		<script src="lib/purify.min.js"></script>

		<script>
			// 初始化 markdown-it
			const md = window
				.markdownit({ html: true })
				// .use(window.markdownitEmoji)
				.use(window.markdownitTaskLists)
				.use(window.markdownitMultimdTable);

			// KaTeX 预处理
			function preRenderTex(source) {
				// 块级公式
				source = source.replace(/\$\$([\s\S]+?)\$\$/g, (m, tex) =>
					katex.renderToString(tex, {
						displayMode: true,
						throwOnError: false,
						output: "html",
					})
				);
				// 行内公式
				source = source.replace(
					/(^|[^$])\$([^\n$][^$]*?)\$([^$]|$)/g,
					(m, p1, tex, p3) =>
						p1 +
						katex.renderToString(tex, {
							displayMode: false,
							throwOnError: false,
							output: "html",
						}) +
						p3
				);
				return source;
			}

			function render() {
				const src = document.getElementById("editor").value;
				const preProcessed = preRenderTex(src);
				const dirty = md.render(preProcessed);

				// 清理 XSS，同时保留 KaTeX 生成的 span/class
				const clean = DOMPurify.sanitize(dirty, {
					ADD_TAGS: ["span"],
					ADD_ATTR: ["class", "style"],
				});

				document.getElementById("preview").innerHTML = clean;
			}

			document.getElementById("editor").addEventListener("input", render);
			render();
		</script>
	</body>
</html>
