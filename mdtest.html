<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8" />
		<title>Markdown + KaTeX Demo</title>
		<link
			rel="stylesheet"
			href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css" />

		<style>
			body {
				font-family: sans-serif;
				display: flex;
				gap: 1rem;
				padding: 1rem;
			}
			textarea {
				width: 40%;
				height: 90vh;
			}
			#preview {
				width: 55%;
				padding: 1rem;
				border: 1px solid #ccc;
				height: 90vh;
				overflow: auto;
			}
			#preview table,
			th,
			td {
				border: 1px solid #000;
				border-collapse: collapse;
				padding: 5px;
			}
		</style>
	</head>
	<body>
		<textarea id="editor">
# æµ‹è¯• Markdown + KaTeX

- [x] å·²å®Œæˆ
- [ ] å¾…å®Œæˆ
- [ ] ğŸ˜ Emoji ä¹Ÿæ”¯æŒ

è¡Œå†…å…¬å¼ï¼š$E = mc^2$

å—çº§å…¬å¼ï¼š
$$
\int_0^1 x^2 dx = \frac{1}{3}
$$

| å§“å | åˆ†æ•° |
| ---- | ---- |
| å°æ˜ | 95 |
| å°çº¢ | 88 |
</textarea
		>

		<div id="preview"></div>

		<!-- å¼•å…¥ä¾èµ–ï¼ˆCDNï¼‰ -->
		<script src="https://cdn.jsdelivr.net/npm/markdown-it@14.1.0/dist/markdown-it.min.js"></script>
		<!-- <script src="https://cdn.jsdelivr.net/npm/markdown-it-emoji/dist/markdown-it-emoji.min.js"></script> -->
		<script src="https://cdn.jsdelivr.net/npm/markdown-it-task-lists/dist/markdown-it-task-lists.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/markdown-it-multimd-table/dist/markdown-it-multimd-table.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>

		<script>
			// åˆå§‹åŒ– markdown-it
			const md = window
				.markdownit({ html: true })
				// .use(window.markdownitEmoji)
				.use(window.markdownitTaskLists)
				.use(window.markdownitMultimdTable);

			// KaTeX é¢„å¤„ç†
			function preRenderTex(source) {
				// å—çº§å…¬å¼
				source = source.replace(/\$\$([\s\S]+?)\$\$/g, (m, tex) =>
					katex.renderToString(tex, {
						displayMode: true,
						throwOnError: false,
						output: "html",
					})
				);
				// è¡Œå†…å…¬å¼
				source = source.replace(
					/(^|[^$])\$([^\n$][^$]*?)\$([^$]|$)/g,
					(m, p1, tex, p3) =>
						p1 +
						katex.renderToString(tex, {
							displayMode: false,
							throwOnError: false,
							output: "html",
						}) +
						p3
				);
				return source;
			}

			function render() {
				const src = document.getElementById("editor").value;
				const preProcessed = preRenderTex(src);
				const dirty = md.render(preProcessed);

				// æ¸…ç† XSSï¼ŒåŒæ—¶ä¿ç•™ KaTeX ç”Ÿæˆçš„ span/class
				const clean = DOMPurify.sanitize(dirty, {
					ADD_TAGS: ["span"],
					ADD_ATTR: ["class", "style"],
				});

				document.getElementById("preview").innerHTML = clean;
			}

			document.getElementById("editor").addEventListener("input", render);
			render();
		</script>
	</body>
</html>
