<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<title>创建聊天频道</title>
		<link
			rel="icon"
			type="image/bmp"
			href="favicon.bmp" />
		<script src="/js/spark-md5.min.js"></script>
		<script src="/js/base64.min.js"></script>
		<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
		<script src="/js/api.js"></script>
	</head>
	<body>
		<script>
			function getkey() {
				return SparkMD5.hash(String(getid()) + String(getarg().key));
			}
			if (
				(getarg().type != "r" && getarg().type != "u") ||
				(getarg().type == "r" && !getarg().key) ||
				(getarg().type == "u" && !getarg().ch)
			) {
				document.body.innerHTML = "Error! 你确定这不是你输错了？";
			} else if (getarg().type == "u") {
				$.ajax({
					url: "https://gitee.com/api/v5/repos/zyc-2024/chat/raw/public/index.json",
					crossDomain: true,
					contentType: "application/json;charset=UTF-8",
					data: {
						access_token: "19f7b43872c256d52d1bc71cbd2d0ffa",
					},
				}).done(function (response) {
					r = JSON.parse(response);
					r.ch[r.ch.length] = getarg().ch;
					shaa = r.sha;
					$.get(
						"https://gitee.com/api/v5/repos/zyc-2024/chat/contents/public%2Fmsg%2F" +
							getarg().ch +
							".json",
						{
							access_token: "19f7b43872c256d52d1bc71cbd2d0ffa",
						}
					).done(function (response) {
						var t = new Date();
						$.get(
							"https://gitee.com/api/v5/repos/zyc-2024/chat/contents/public/index.json?access_token=19f7b43872c256d52d1bc71cbd2d0ffa"
						).done(function (response) {
							console.log(response);
							let itssha = response.sha;
							$.ajax({
								url: "https://gitee.com/api/v5/repos/zyc-2024/chat/contents/public%2Findex.json",
								crossDomain: true,
								method: "PUT",
								contentType: "application/json;charset=UTF-8",
								data: JSON.stringify({
									access_token:
										"19f7b43872c256d52d1bc71cbd2d0ffa",
									content: Base64.encode(JSON.stringify(r)),
									sha: itssha,
									message: "update index",
								}),
							}).done(function (response) {
								$.ajax({
									url:
										"https://gitee.com/api/v5/repos/zyc-2024/chat/contents/public%2Fmsg%2F" +
										getarg().ch +
										".json",
									crossDomain: true,
									method: "post",
									contentType:
										"application/json;charset=UTF-8",
									data: JSON.stringify({
										access_token:
											"19f7b43872c256d52d1bc71cbd2d0ffa",
										content: Base64.encode(
											JSON.stringify({
												msg: [
													{
														name: getname(),
														time: gettime(),
														content:
															'Created channel "' +
															getarg().ch +
															'"',
													},
												],
											})
										),
										message:
											"initial public[" +
											getarg().ch +
											"]",
									}),
								}).done(function (response) {
									window.location.href =
										"public.html?ch=" + getarg().ch;
								});
							});
						});
					});
				});
			} else {
				$.ajax({
					url:
						"https://gitee.com/api/v5/repos/zyc-2024/chat/contents/private%2Fmsg%2F" +
						getid() +
						"_" +
						SparkMD5.hash(getarg().key) +
						".json",
					crossDomain: true,
					method: "post",
					contentType: "application/json;charset=UTF-8",
					data: JSON.stringify({
						access_token: "19f7b43872c256d52d1bc71cbd2d0ffa",
						content: Base64.encode(
							JSON.stringify({
								msg: [
									{
										name: getname(),
										time: gettime(),
										content:
											"This private channel has just been created!",
									},
									{
										name: getname(),
										time: gettime(),
										content:
											"Id:" +
											getid() +
											"\nKey:" +
											getarg().key,
									},
									{
										name: getname(),
										time: gettime(),
										content: "Please remember them!",
									},
								],
							})
						),
						message:
							"initial private[" +
							getid() +
							"]+[" +
							SparkMD5.hash(getarg().key) +
							"]",
					}),
				}).done(function (response) {
					addid();
					window.location.href =
						"private.html?id=" + getid() + "&key=" + getarg().key;
				});
			}
		</script>
	</body>
</html>
